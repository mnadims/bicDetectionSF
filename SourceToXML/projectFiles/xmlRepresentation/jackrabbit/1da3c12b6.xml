<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<unit xmlns="http://www.srcML.org/srcML/src" revision="1.0.0" language="Java" filename="E:/01Courses@USASK/CMPT898-HumanDrivenSoftwareEngineeringForScientificResearch/ProjectProgress/data_files/final_dataset/gen_patch_codes/filtered/jackrabbit/1da3c12b6.java"><expr_stmt><expr><name>From</name> <literal type="number">1da3c12b6bc4adc8c8a704d1cf7791f3d30064cb</literal> <name>Mon</name> <name>Sep</name> <literal type="number">17</literal> <literal type="number">00</literal><operator>:</operator><literal type="number">00</literal><operator>:</operator><literal type="number">00</literal> <literal type="number">2001</literal>
<name>From</name><operator>:</operator> <name>Julian</name> <name><name>Reschke</name> <argument_list type="generic">&lt;<argument><name>reschke</name><annotation>@<name><name>apache</name><operator>.</operator><name>org</name></name></annotation></argument>&gt;</argument_list></name>
<name>Date</name><operator>:</operator> <name>Tue</name></expr><operator>,</operator> <expr><literal type="number">18</literal> <name>Oct</name> <literal type="number">2011</literal> <literal type="number">14</literal><operator>:</operator><literal type="number">38</literal><operator>:</operator><literal type="number">33</literal> <operator>+</operator><literal type="number">0000</literal>
<name>Subject</name><operator>:</operator> <index>[<expr><name>PATCH</name></expr>]</index> <name>JCR</name><operator>-</operator><literal type="number">3115</literal><operator>:</operator> <name>Versioning</name> <name>fixup</name> <name>leaves</name> <name>persistence</name> <name>in</name> <name>a</name> <name>state</name>
 <name>where</name> <name>the</name> <name>node</name> <name>can</name><literal type="char">'t be made versionable again

git-svn-id: https://svn.apache.org/repos/asf/jackrabbit/trunk@1185691 13f79535-47bb-0310-9956-ffa450edef68
--
 .../jackrabbit/core/RepositoryChecker.java    | 92 ++++++++++++++++---
 .../version/InconsistentVersioningState.java  | 24 ++++-
 .../version/InternalVersionHistoryImpl.java   |  4 +-
 .../core/version/InternalVersionImpl.java     |  2 +-
 .../version/InternalVersionManagerBase.java   | 14 ++-
 5 files changed, 110 insertions(+), 26 deletions(-)

diff --git a/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/RepositoryChecker.java b/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/RepositoryChecker.java
index aa28341f2..f0d908137 100644
-- a/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/RepositoryChecker.java
++ b/jackrabbit-core/src/main/java/org/apache/jackrabbit/core/RepositoryChecker.java
@@ -24,6 +24,7 @@ import static org.apache.jackrabbit.spi.commons.name.NameConstants.JCR_ROOTVERSI
 import static org.apache.jackrabbit.spi.commons.name.NameConstants.JCR_VERSIONHISTORY;
 import static org.apache.jackrabbit.spi.commons.name.NameConstants.MIX_VERSIONABLE;
 
import java.util.Calendar;
 import java.util.HashSet;
 import java.util.Set;
 
@@ -39,8 +40,11 @@ import org.apache.jackrabbit.core.state.NodeState;
 import org.apache.jackrabbit.core.version.InconsistentVersioningState;
 import org.apache.jackrabbit.core.version.InternalVersion;
 import org.apache.jackrabbit.core.version.InternalVersionHistory;
import org.apache.jackrabbit.core.version.InternalVersionManager;
import org.apache.jackrabbit.core.version.InternalVersionManagerImpl;
 import org.apache.jackrabbit.spi.Name;
import org.apache.jackrabbit.spi.NameFactory;
import org.apache.jackrabbit.spi.commons.name.NameFactoryImpl;
import org.apache.jackrabbit.util.ISO8601;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 
@@ -62,13 +66,16 @@ class RepositoryChecker {
 
     private final ChangeLog workspaceChanges;
 
    private final InternalVersionManager versionManager;
    private final ChangeLog vworkspaceChanges;

    private final InternalVersionManagerImpl versionManager;
 
     public RepositoryChecker(
             PersistenceManager workspace,
            InternalVersionManager versionManager) {
            InternalVersionManagerImpl versionManager) {
         this.workspace = workspace;
         this.workspaceChanges = new ChangeLog();
        this.vworkspaceChanges = new ChangeLog();
         this.versionManager = versionManager;
     }
 
@@ -91,25 +98,33 @@ class RepositoryChecker {
         }
     }
 
    public void fix() throws RepositoryException {
        if (workspaceChanges.hasUpdates()) {
            log.warn("Fixing repository inconsistencies");
    private void fix(PersistenceManager pm, ChangeLog changes, String store)
            throws RepositoryException {
        if (changes.hasUpdates()) {
            log.warn("Fixing " + store + " inconsistencies");
             try {
                workspace.store(workspaceChanges);
                pm.store(changes);
             } catch (ItemStateException e) {
                e.printStackTrace();
                throw new RepositoryException(
                        "Failed to fix workspace inconsistencies", e);
                String message = "Failed to fix " + store + " inconsistencies (aborting)";
                log.error(message, e);
                throw new RepositoryException(message, e);
             }
         } else {
            log.info("No repository inconsistencies found");
            log.info("No " + store + "  inconsistencies found");
         }
     }
 
    public void fix() throws RepositoryException {
        fix(workspace, workspaceChanges, "workspace");
        fix(versionManager.getPersistenceManager(), vworkspaceChanges,
                "versioning workspace");
    }

     private void checkVersionHistory(NodeState node) {
         if (node.hasPropertyName(JCR_VERSIONHISTORY)) {
             String message = null;
             NodeId nid = node.getNodeId();
            NodeId vhid = null;
 
             try {
                 log.debug("Checking version history of node {}", nid);
@@ -117,6 +132,8 @@ class RepositoryChecker {
                 message = "Removing references to a missing version history of node " + nid;
                 InternalVersionHistory vh = versionManager.getVersionHistoryOfNode(nid);
 
                vhid = vh.getId();
                
                 // additional checks, see JCR-3101
                 String intro = "Removing references to an inconsistent version history of node "
                     + nid;
@@ -144,14 +161,25 @@ class RepositoryChecker {
                     message = intro + " (root version is missing)";
                     throw new InconsistentVersioningState("root version of " + nid +" is missing.");
                 }
            } catch (InconsistentVersioningState e) {
                log.info(message, e);
                NodeId nvhid = e.getVersionHistoryNodeId();
                if (nvhid != null) {
                    if (vhid != null &amp;&amp; !nvhid.equals(vhid)) {
                        log.error("vhrid returned with InconsistentVersioningState does not match the id we already had: "
                                + vhid + " vs " + nvhid);
                    }
                    vhid = nvhid; 
                }
                removeVersionHistoryReferences(node, vhid);
             } catch (Exception e) {
                 log.info(message, e);
                removeVersionHistoryReferences(node);
                removeVersionHistoryReferences(node, vhid);
             }
         }
     }
 
    private void removeVersionHistoryReferences(NodeState node) {
    private void removeVersionHistoryReferences(NodeState node, NodeId vhid) {
         NodeState modified =
             new NodeState(node, NodeState.STATUS_EXISTING_MODIFIED, true);
 
@@ -166,6 +194,44 @@ class RepositoryChecker {
         removeProperty(modified, JCR_ISCHECKEDOUT);
 
         workspaceChanges.modified(modified);
        
        if (vhid != null) {
            // attempt to rename the version history, so it doesn'</literal><name>t</name> <name>interfere</name> <name>with</name>
            <comment type="line">// a future attempt to put the node under version control again </comment>
            <comment type="line">// (see JCR-3115)</comment>
            
            <call><name><name>log</name><operator>.</operator><name>info</name></name><argument_list>(<argument><expr><literal type="string">"trying to rename version history of node "</literal> <operator>+</operator> <call><name><name>node</name><operator>.</operator><name>getId</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>

            <decl_stmt><decl><type><name>NameFactory</name></type> <name>nf</name> <init>= <expr><call><name><name>NameFactoryImpl</name><operator>.</operator><name>getInstance</name></name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>
            
            <comment type="line">// Name of VHR in parent folder is ID of versionable node</comment>
            <decl_stmt><decl><type><name>Name</name></type> <name>vhrname</name> <init>= <expr><call><name><name>nf</name><operator>.</operator><name>create</name></name><argument_list>(<argument><expr><name><name>Name</name><operator>.</operator><name>NS_DEFAULT_URI</name></name></expr></argument>, <argument><expr><call><name><name>node</name><operator>.</operator><name>getId</name></name><argument_list>()</argument_list></call><operator>.</operator><call><name>toString</name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

            <try>try <block>{<block_content>
                <decl_stmt><decl><type><name>NodeState</name></type> <name>vhrState</name> <init>= <expr><call><name><name>versionManager</name><operator>.</operator><name>getPersistenceManager</name></name><argument_list>()</argument_list></call><operator>.</operator><call><name>load</name><argument_list>(<argument><expr><name>vhid</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
                <decl_stmt><decl><type><name>NodeState</name></type> <name>vhrParentState</name> <init>= <expr><call><name><name>versionManager</name><operator>.</operator><name>getPersistenceManager</name></name><argument_list>()</argument_list></call><operator>.</operator><call><name>load</name><argument_list>(<argument><expr><call><name><name>vhrState</name><operator>.</operator><name>getParentId</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
                
                <if_stmt><if>if <condition>(<expr><call><name><name>vhrParentState</name><operator>.</operator><name>hasChildNodeEntry</name></name><argument_list>(<argument><expr><name>vhrname</name></expr></argument>)</argument_list></call></expr>)</condition> <block>{<block_content>
                    <decl_stmt><decl><type><name>NodeState</name></type> <name>modifiedParent</name> <init>= <expr><operator>(</operator><name>NodeState</name><operator>)</operator> <call><name><name>vworkspaceChanges</name><operator>.</operator><name>get</name></name><argument_list>(<argument><expr><call><name><name>vhrState</name><operator>.</operator><name>getParentId</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
                    <if_stmt><if>if <condition>(<expr><name>modifiedParent</name> <operator>==</operator> <literal type="null">null</literal></expr>)</condition> <block>{<block_content>
                        <expr_stmt><expr><name>modifiedParent</name> <operator>=</operator> <operator>new</operator> <call><name>NodeState</name><argument_list>(<argument><expr><name>vhrParentState</name></expr></argument>, <argument><expr><name><name>NodeState</name><operator>.</operator><name>STATUS_EXISTING_MODIFIED</name></name></expr></argument>, <argument><expr><literal type="boolean">true</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                    </block_content>}</block></if></if_stmt>
                    
                    <decl_stmt><decl><type><name>Calendar</name></type> <name>now</name> <init>= <expr><call><name><name>Calendar</name><operator>.</operator><name>getInstance</name></name><argument_list>()</argument_list></call></expr></init></decl>;</decl_stmt>
                    <decl_stmt><decl><type><name>String</name></type> <name>appendme</name> <init>= <expr><literal type="string">" (disconnected by RepositoryChecker on "</literal>
                            <operator>+</operator> <call><name><name>ISO8601</name><operator>.</operator><name>format</name></name><argument_list>(<argument><expr><name>now</name></expr></argument>)</argument_list></call> <operator>+</operator> <literal type="string">")"</literal></expr></init></decl>;</decl_stmt>
                    <expr_stmt><expr><call><name><name>modifiedParent</name><operator>.</operator><name>renameChildNodeEntry</name></name><argument_list>(<argument><expr><name>vhid</name></expr></argument>,
                            <argument><expr><call><name><name>nf</name><operator>.</operator><name>create</name></name><argument_list>(<argument><expr><call><name><name>vhrname</name><operator>.</operator><name>getNamespaceURI</name></name><argument_list>()</argument_list></call></expr></argument>, <argument><expr><call><name><name>vhrname</name><operator>.</operator><name>getLocalName</name></name><argument_list>()</argument_list></call> <operator>+</operator> <name>appendme</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>

                    <expr_stmt><expr><call><name><name>vworkspaceChanges</name><operator>.</operator><name>modified</name></name><argument_list>(<argument><expr><name>modifiedParent</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                </block_content>}</block></if>
                <else>else <block>{<block_content>
                    <expr_stmt><expr><call><name><name>log</name><operator>.</operator><name>info</name></name><argument_list>(<argument><expr><literal type="string">"child node entry "</literal> <operator>+</operator> <name>vhrname</name> <operator>+</operator> <literal type="string">" for version history not found inside parent folder."</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                </block_content>}</block></else></if_stmt>
            </block_content>}</block> <catch>catch <parameter_list>(<parameter><decl><type><name>Exception</name></type> <name>ex</name></decl></parameter>)</parameter_list> <block>{<block_content>
                <expr_stmt><expr><call><name><name>log</name><operator>.</operator><name>error</name></name><argument_list>(<argument><expr><literal type="string">"while trying to rename the version history"</literal></expr></argument>, <argument><expr><name>ex</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
            </block_content>}</block></catch></try>
        }
     }
 
     <function><type><specifier>private</specifier> <name>void</name></type> <name>removeProperty</name><parameter_list>(<parameter><decl><type><name>NodeState</name></type> <name>node</name></decl></parameter>, <parameter><decl><type><name>Name</name></type> <name>name</name></decl></parameter>)</parameter_list> <block>{<block_content>
<expr_stmt><expr><name>diff</name> <operator>--</operator><name>git</name> <name>a</name><operator>/</operator><name>jackrabbit</name><operator>-</operator><name>core</name><operator>/</operator><name>src</name><operator>/</operator><name>main</name><operator>/</operator><name>java</name><operator>/</operator><name>org</name><operator>/</operator><name>apache</name><operator>/</operator><name>jackrabbit</name><operator>/</operator><name>core</name><operator>/</operator><name>version</name><operator>/</operator><name><name>InconsistentVersioningState</name><operator>.</operator><name>java</name></name> <name>b</name><operator>/</operator><name>jackrabbit</name><operator>-</operator><name>core</name><operator>/</operator><name>src</name><operator>/</operator><name>main</name><operator>/</operator><name>java</name><operator>/</operator><name>org</name><operator>/</operator><name>apache</name><operator>/</operator><name>jackrabbit</name><operator>/</operator><name>core</name><operator>/</operator><name>version</name><operator>/</operator><name><name>InconsistentVersioningState</name><operator>.</operator><name>java</name></name>
<name>index</name> <literal type="number">6d0d8a2ef</literal><operator>..</operator><literal type="number">74822d5d9</literal> <literal type="number">100644</literal>
<operator>--</operator> <name>a</name><operator>/</operator><name>jackrabbit</name><operator>-</operator><name>core</name><operator>/</operator><name>src</name><operator>/</operator><name>main</name><operator>/</operator><name>java</name><operator>/</operator><name>org</name><operator>/</operator><name>apache</name><operator>/</operator><name>jackrabbit</name><operator>/</operator><name>core</name><operator>/</operator><name>version</name><operator>/</operator><name><name>InconsistentVersioningState</name><operator>.</operator><name>java</name></name>
<operator>++</operator> <name>b</name><operator>/</operator><name>jackrabbit</name><operator>-</operator><name>core</name><operator>/</operator><name>src</name><operator>/</operator><name>main</name><operator>/</operator><name>java</name><operator>/</operator><name>org</name><operator>/</operator><name>apache</name><operator>/</operator><name>jackrabbit</name><operator>/</operator><name>core</name><operator>/</operator><name>version</name><operator>/</operator><name><name>InconsistentVersioningState</name><operator>.</operator><name>java</name></name>
@@ <operator>-</operator><literal type="number">16</literal></expr><operator>,</operator><expr><literal type="number">6</literal> <operator>+</operator><literal type="number">16</literal></expr><operator>,</operator><expr><literal type="number">8</literal> @@
  <operator>*</operator><operator>/</operator></expr></expr_stmt>
 <package>package <name><name>org</name><operator>.</operator><name>apache</name><operator>.</operator><name>jackrabbit</name><operator>.</operator><name>core</name><operator>.</operator><name>version</name></name>;</package>
 
<import>import <name><name>org</name><operator>.</operator><name>apache</name><operator>.</operator><name>jackrabbit</name><operator>.</operator><name>core</name><operator>.</operator><name>id</name><operator>.</operator><name>NodeId</name></name>;</import>

 <comment type="block" format="javadoc">/**
  * The &lt;code&gt;InconsistentVersionControlState&lt;/code&gt; is used to signal
  * inconsistencies in the versioning related state of a node, such
@@ -23,6 +25,8 @@ package org.apache.jackrabbit.core.version;
  */</comment>
 <class><specifier>public</specifier> class <name>InconsistentVersioningState</name> <super_list><extends>extends <super><name>RuntimeException</name></super></extends></super_list> <block>{
 
    <decl_stmt><decl><type><specifier>private</specifier> <specifier>final</specifier> <name>NodeId</name></type> <name>versionHistoryNodeId</name></decl>;</decl_stmt>
    
     <comment type="block" format="javadoc">/**
      * Constructs a new instance of this class with the specified detail
      * message.
@@ -32,18 +36,28 @@ public class InconsistentVersioningState extends RuntimeException {
      */</comment>
     <constructor><specifier>public</specifier> <name>InconsistentVersioningState</name><parameter_list>(<parameter><decl><type><name>String</name></type> <name>message</name></decl></parameter>)</parameter_list> <block>{<block_content>
         <expr_stmt><expr><call><name>super</name><argument_list>(<argument><expr><name>message</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><name><name>this</name><operator>.</operator><name>versionHistoryNodeId</name></name> <operator>=</operator> <literal type="null">null</literal></expr>;</expr_stmt>
     </block_content>}</block></constructor>
 
     <comment type="block" format="javadoc">/**
      * Constructs a new instance of this class with the specified detail
     * message and root cause.
     * message.
      *
     * @param message   the detail message. The detail message is saved for
     *                  later retrieval by the {@link #getMessage()} method.
     * @param rootCause root failure cause
     * @param message the detail message. The detail message is saved for
     *                later retrieval by the {@link #getMessage()} method.
     * @param rootCause root cause (or otherwise &lt;code&gt;null&lt;/code&gt;)
     * @param versionHistoryNodeId NodeId of the version history that has problems (or otherwise &lt;code&gt;null&lt;/code&gt;
      */</comment>
    <constructor><specifier>public</specifier> <name>InconsistentVersioningState</name><parameter_list>(<parameter><decl><type><name>String</name></type> <name>message</name></decl></parameter>, <parameter><decl><type><name>Throwable</name></type> <name>rootCause</name></decl></parameter>)</parameter_list> <block>{<block_content>
    <constructor><specifier>public</specifier> <name>InconsistentVersioningState</name><parameter_list>(<parameter><decl><type><name>String</name></type> <name>message</name></decl></parameter>, <parameter><decl><type><name>NodeId</name></type> <name>versionHistoryNodeId</name></decl></parameter>, <parameter><decl><type><name>Throwable</name></type> <name>rootCause</name></decl></parameter>)</parameter_list> <block>{<block_content>
         <expr_stmt><expr><call><name>super</name><argument_list>(<argument><expr><name>message</name></expr></argument>, <argument><expr><name>rootCause</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><name><name>this</name><operator>.</operator><name>versionHistoryNodeId</name></name> <operator>=</operator> <name>versionHistoryNodeId</name></expr>;</expr_stmt>
     </block_content>}</block></constructor>
 
    <comment type="block" format="javadoc">/**
     * @return the NodeId of the version history having problems or &lt;code&gt;null&lt;/code&gt;
     * when unknown.
     */</comment>
    <function><type><specifier>public</specifier> <name>NodeId</name></type> <name>getVersionHistoryNodeId</name><parameter_list>()</parameter_list> <block>{<block_content>
        <return>return <expr><name><name>this</name><operator>.</operator><name>versionHistoryNodeId</name></name></expr>;</return>
    </block_content>}</block></function>
 </block_content>}</block></constructor>
<expr_stmt><expr><name>diff</name> <operator>--</operator><name>git</name> <name>a</name><operator>/</operator><name>jackrabbit</name><operator>-</operator><name>core</name><operator>/</operator><name>src</name><operator>/</operator><name>main</name><operator>/</operator><name>java</name><operator>/</operator><name>org</name><operator>/</operator><name>apache</name><operator>/</operator><name>jackrabbit</name><operator>/</operator><name>core</name><operator>/</operator><name>version</name><operator>/</operator><name><name>InternalVersionHistoryImpl</name><operator>.</operator><name>java</name></name> <name>b</name><operator>/</operator><name>jackrabbit</name><operator>-</operator><name>core</name><operator>/</operator><name>src</name><operator>/</operator><name>main</name><operator>/</operator><name>java</name><operator>/</operator><name>org</name><operator>/</operator><name>apache</name><operator>/</operator><name>jackrabbit</name><operator>/</operator><name>core</name><operator>/</operator><name>version</name><operator>/</operator><name><name>InternalVersionHistoryImpl</name><operator>.</operator><name>java</name></name>
<name>index</name> <literal type="number">429b1f120</literal><operator>..</operator><name>c3e42d3fb</name> <literal type="number">100644</literal>
<operator>--</operator> <name>a</name><operator>/</operator><name>jackrabbit</name><operator>-</operator><name>core</name><operator>/</operator><name>src</name><operator>/</operator><name>main</name><operator>/</operator><name>java</name><operator>/</operator><name>org</name><operator>/</operator><name>apache</name><operator>/</operator><name>jackrabbit</name><operator>/</operator><name>core</name><operator>/</operator><name>version</name><operator>/</operator><name><name>InternalVersionHistoryImpl</name><operator>.</operator><name>java</name></name>
<operator>++</operator> <name>b</name><operator>/</operator><name>jackrabbit</name><operator>-</operator><name>core</name><operator>/</operator><name>src</name><operator>/</operator><name>main</name><operator>/</operator><name>java</name><operator>/</operator><name>org</name><operator>/</operator><name>apache</name><operator>/</operator><name>jackrabbit</name><operator>/</operator><name>core</name><operator>/</operator><name>version</name><operator>/</operator><name><name>InternalVersionHistoryImpl</name><operator>.</operator><name>java</name></name>
@@ <operator>-</operator><literal type="number">213</literal></expr><operator>,</operator><expr><literal type="number">7</literal> <operator>+</operator><literal type="number">213</literal></expr><operator>,</operator><expr><literal type="number">7</literal> @@ <name>class</name> <name>InternalVersionHistoryImpl</name> extends <name>InternalVersionItemImpl</name></expr></expr_stmt>
             }</block></class>
             <return>return <expr><name>v</name></expr>;</return>
         </block_content>}</block></function> <catch>catch <parameter_list>(<parameter><decl><type><name>RepositoryException</name></type> <name>e</name></decl></parameter>)</parameter_list> <block>{<block_content>
            <throw>throw <expr><operator>new</operator> <call><name>IllegalArgumentException</name><argument_list>(<argument><expr><literal type="string">"Failed to create version "</literal> <operator>+</operator> <name>name</name> <operator>+</operator> <literal type="string">"."</literal></expr></argument>)</argument_list></call></expr>;</throw>
            <throw>throw <expr><operator>new</operator> <call><name>InconsistentVersioningState</name><argument_list>(<argument><expr><literal type="string">"Failed to create version "</literal> <operator>+</operator> <name>name</name> <operator>+</operator> <literal type="string">" in VHR "</literal> <operator>+</operator> <name>historyId</name> <operator>+</operator> <literal type="string">"."</literal></expr></argument>, <argument><expr><name>historyId</name></expr></argument>, <argument><expr><literal type="null">null</literal></expr></argument>)</argument_list></call></expr>;</throw>
         </block_content>}</block></catch>
     }
 
@<annotation>@</annotation> -<expr_stmt><expr><literal type="number">238</literal></expr><operator>,</operator><expr><literal type="number">7</literal> <operator>+</operator><literal type="number">238</literal></expr><operator>,</operator><expr><literal type="number">7</literal> @@ <name>class</name> <name>InternalVersionHistoryImpl</name> extends <name>InternalVersionItemImpl</name>
                     <name>v</name> <operator>=</operator> <operator>new</operator> <call><name>InternalVersionImpl</name><argument_list>(<argument><expr><name>this</name></expr></argument>, <argument><expr><name>child</name></expr></argument>, <argument><expr><call><name><name>child</name><operator>.</operator><name>getName</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                 }
             } <catch>catch <parameter_list>(<parameter><decl><type><name>RepositoryException</name></type> <name>e</name></decl></parameter>)</parameter_list> <block>{<block_content>
                <throw>throw <expr><operator>new</operator> <call><name>InconsistentVersioningState</name><argument_list>(<argument><expr><literal type="string">"Version does not have a jcr:frozenNode: "</literal> <operator>+</operator> <call><name><name>child</name><operator>.</operator><name>getNodeId</name></name><argument_list>()</argument_list></call></expr></argument>, <argument><expr><name>e</name></expr></argument>)</argument_list></call></expr>;</throw>
                <throw>throw <expr><operator>new</operator> <call><name>InconsistentVersioningState</name><argument_list>(<argument><expr><literal type="string">"Version does not have a jcr:frozenNode: "</literal> <operator>+</operator> <call><name><name>child</name><operator>.</operator><name>getNodeId</name></name><argument_list>()</argument_list></call></expr></argument>, <argument><expr><name>historyId</name></expr></argument>, <argument><expr><name>e</name></expr></argument>)</argument_list></call></expr>;</throw>
             </block_content>}</block></catch>
         }
         return <expr_stmt><expr><name>v</name></expr>;</expr_stmt>
<expr_stmt><expr><name>diff</name> <operator>--</operator><name>git</name> <name>a</name><operator>/</operator><name>jackrabbit</name><operator>-</operator><name>core</name><operator>/</operator><name>src</name><operator>/</operator><name>main</name><operator>/</operator><name>java</name><operator>/</operator><name>org</name><operator>/</operator><name>apache</name><operator>/</operator><name>jackrabbit</name><operator>/</operator><name>core</name><operator>/</operator><name>version</name><operator>/</operator><name><name>InternalVersionImpl</name><operator>.</operator><name>java</name></name> <name>b</name><operator>/</operator><name>jackrabbit</name><operator>-</operator><name>core</name><operator>/</operator><name>src</name><operator>/</operator><name>main</name><operator>/</operator><name>java</name><operator>/</operator><name>org</name><operator>/</operator><name>apache</name><operator>/</operator><name>jackrabbit</name><operator>/</operator><name>core</name><operator>/</operator><name>version</name><operator>/</operator><name><name>InternalVersionImpl</name><operator>.</operator><name>java</name></name>
<name>index</name> <name>a1c9d20a6</name><operator>..</operator><name>ec79ec0c4</name> <literal type="number">100644</literal>
<operator>--</operator> <name>a</name><operator>/</operator><name>jackrabbit</name><operator>-</operator><name>core</name><operator>/</operator><name>src</name><operator>/</operator><name>main</name><operator>/</operator><name>java</name><operator>/</operator><name>org</name><operator>/</operator><name>apache</name><operator>/</operator><name>jackrabbit</name><operator>/</operator><name>core</name><operator>/</operator><name>version</name><operator>/</operator><name><name>InternalVersionImpl</name><operator>.</operator><name>java</name></name>
<operator>++</operator> <name>b</name><operator>/</operator><name>jackrabbit</name><operator>-</operator><name>core</name><operator>/</operator><name>src</name><operator>/</operator><name>main</name><operator>/</operator><name>java</name><operator>/</operator><name>org</name><operator>/</operator><name>apache</name><operator>/</operator><name>jackrabbit</name><operator>/</operator><name>core</name><operator>/</operator><name>version</name><operator>/</operator><name><name>InternalVersionImpl</name><operator>.</operator><name>java</name></name>
@@ <operator>-</operator><literal type="number">121</literal></expr><operator>,</operator><expr><literal type="number">7</literal> <operator>+</operator><literal type="number">121</literal></expr><operator>,</operator><expr><literal type="number">7</literal> @@ <name>class</name> <name>InternalVersionImpl</name> extends <name>InternalVersionItemImpl</name></expr></expr_stmt>
         <try>try <block>{<block_content>
             <return>return <expr><operator>(</operator><name>InternalFrozenNode</name><operator>)</operator> <call><name><name>vMgr</name><operator>.</operator><name>getItem</name></name><argument_list>(<argument><expr><call><name>getFrozenNodeId</name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr>;</return>
         </block_content>}</block> <catch>catch <parameter_list>(<parameter><decl><type><name>RepositoryException</name></type> <name>e</name></decl></parameter>)</parameter_list> <block>{<block_content>
            <throw>throw <expr><operator>new</operator> <call><name>InconsistentVersioningState</name><argument_list>(<argument><expr><literal type="string">"unable to retrieve frozen node: "</literal> <operator>+</operator> <name>e</name></expr></argument>, <argument><expr><name>e</name></expr></argument>)</argument_list></call></expr>;</throw>
            <throw>throw <expr><operator>new</operator> <call><name>InconsistentVersioningState</name><argument_list>(<argument><expr><literal type="string">"unable to retrieve frozen node: "</literal> <operator>+</operator> <name>e</name></expr></argument>, <argument><expr><literal type="null">null</literal></expr></argument>, <argument><expr><name>e</name></expr></argument>)</argument_list></call></expr>;</throw>
         </block_content>}</block></catch></try>
     }
 
diff <expr_stmt><expr><operator>--</operator><name>git</name> <name>a</name><operator>/</operator><name>jackrabbit</name><operator>-</operator><name>core</name><operator>/</operator><name>src</name><operator>/</operator><name>main</name><operator>/</operator><name>java</name><operator>/</operator><name>org</name><operator>/</operator><name>apache</name><operator>/</operator><name>jackrabbit</name><operator>/</operator><name>core</name><operator>/</operator><name>version</name><operator>/</operator><name><name>InternalVersionManagerBase</name><operator>.</operator><name>java</name></name> <name>b</name><operator>/</operator><name>jackrabbit</name><operator>-</operator><name>core</name><operator>/</operator><name>src</name><operator>/</operator><name>main</name><operator>/</operator><name>java</name><operator>/</operator><name>org</name><operator>/</operator><name>apache</name><operator>/</operator><name>jackrabbit</name><operator>/</operator><name>core</name><operator>/</operator><name>version</name><operator>/</operator><name><name>InternalVersionManagerBase</name><operator>.</operator><name>java</name></name>
<name>index</name> <name>da83ede94</name><operator>..</operator><literal type="number">3924c87a9</literal> <literal type="number">100755</literal>
<operator>--</operator> <name>a</name><operator>/</operator><name>jackrabbit</name><operator>-</operator><name>core</name><operator>/</operator><name>src</name><operator>/</operator><name>main</name><operator>/</operator><name>java</name><operator>/</operator><name>org</name><operator>/</operator><name>apache</name><operator>/</operator><name>jackrabbit</name><operator>/</operator><name>core</name><operator>/</operator><name>version</name><operator>/</operator><name><name>InternalVersionManagerBase</name><operator>.</operator><name>java</name></name>
<operator>++</operator> <name>b</name><operator>/</operator><name>jackrabbit</name><operator>-</operator><name>core</name><operator>/</operator><name>src</name><operator>/</operator><name>main</name><operator>/</operator><name>java</name><operator>/</operator><name>org</name><operator>/</operator><name>apache</name><operator>/</operator><name>jackrabbit</name><operator>/</operator><name>core</name><operator>/</operator><name>version</name><operator>/</operator><name><name>InternalVersionManagerBase</name><operator>.</operator><name>java</name></name>
@@ <operator>-</operator><literal type="number">17</literal></expr><operator>,</operator><expr><literal type="number">6</literal> <operator>+</operator><literal type="number">17</literal></expr><operator>,</operator><expr><literal type="number">7</literal> @@</expr></expr_stmt>
 <package>package <name><name>org</name><operator>.</operator><name>apache</name><operator>.</operator><name>jackrabbit</name><operator>.</operator><name>core</name><operator>.</operator><name>version</name></name>;</package>
 
 <import>import static <name><name>org</name><operator>.</operator><name>apache</name><operator>.</operator><name>jackrabbit</name><operator>.</operator><name>spi</name><operator>.</operator><name>commons</name><operator>.</operator><name>name</name><operator>.</operator><name>NameConstants</name><operator>.</operator><name>JCR_ACTIVITY</name></name>;</import>
<import>import static <name><name>org</name><operator>.</operator><name>apache</name><operator>.</operator><name>jackrabbit</name><operator>.</operator><name>spi</name><operator>.</operator><name>commons</name><operator>.</operator><name>name</name><operator>.</operator><name>NameConstants</name><operator>.</operator><name>JCR_ROOTVERSION</name></name>;</import>
 <import>import static <name><name>org</name><operator>.</operator><name>apache</name><operator>.</operator><name>jackrabbit</name><operator>.</operator><name>spi</name><operator>.</operator><name>commons</name><operator>.</operator><name>name</name><operator>.</operator><name>NameConstants</name><operator>.</operator><name>JCR_VERSIONHISTORY</name></name>;</import>
 <import>import static <name><name>org</name><operator>.</operator><name>apache</name><operator>.</operator><name>jackrabbit</name><operator>.</operator><name>spi</name><operator>.</operator><name>commons</name><operator>.</operator><name>name</name><operator>.</operator><name>NameConstants</name><operator>.</operator><name>MIX_VERSIONABLE</name></name>;</import>
 
<annotation>@</annotation>@ <expr_stmt><expr><operator>-</operator><literal type="number">31</literal></expr><operator>,</operator><expr><literal type="number">6</literal> <operator>+</operator><literal type="number">32</literal></expr><operator>,</operator><expr><literal type="number">7</literal> @@</expr></expr_stmt> <import>import <name><name>javax</name><operator>.</operator><name>jcr</name><operator>.</operator><name>version</name><operator>.</operator><name>VersionException</name></name>;</import>
 <import>import <name><name>org</name><operator>.</operator><name>apache</name><operator>.</operator><name>jackrabbit</name><operator>.</operator><name>core</name><operator>.</operator><name>id</name><operator>.</operator><name>NodeId</name></name>;</import>
 <import>import <name><name>org</name><operator>.</operator><name>apache</name><operator>.</operator><name>jackrabbit</name><operator>.</operator><name>core</name><operator>.</operator><name>id</name><operator>.</operator><name>NodeIdFactory</name></name>;</import>
 <import>import <name><name>org</name><operator>.</operator><name>apache</name><operator>.</operator><name>jackrabbit</name><operator>.</operator><name>core</name><operator>.</operator><name>nodetype</name><operator>.</operator><name>NodeTypeRegistry</name></name>;</import>
<import>import <name><name>org</name><operator>.</operator><name>apache</name><operator>.</operator><name>jackrabbit</name><operator>.</operator><name>core</name><operator>.</operator><name>state</name><operator>.</operator><name>ChildNodeEntry</name></name>;</import>
 <import>import <name><name>org</name><operator>.</operator><name>apache</name><operator>.</operator><name>jackrabbit</name><operator>.</operator><name>core</name><operator>.</operator><name>state</name><operator>.</operator><name>ItemStateException</name></name>;</import>
 <import>import <name><name>org</name><operator>.</operator><name>apache</name><operator>.</operator><name>jackrabbit</name><operator>.</operator><name>core</name><operator>.</operator><name>state</name><operator>.</operator><name>LocalItemStateManager</name></name>;</import>
 <import>import <name><name>org</name><operator>.</operator><name>apache</name><operator>.</operator><name>jackrabbit</name><operator>.</operator><name>core</name><operator>.</operator><name>state</name><operator>.</operator><name>NodeReferences</name></name>;</import>
<annotation>@</annotation>@ <expr_stmt><expr><operator>-</operator><literal type="number">319</literal></expr><operator>,</operator><expr><literal type="number">12</literal> <operator>+</operator><literal type="number">321</literal></expr><operator>,</operator><expr><literal type="number">14</literal> @@ <specifier>abstract</specifier> <name>class</name> <name>InternalVersionManagerBase</name> implements <name>InternalVersionManager</name> <block>{
             <if_stmt><if>if <condition>(<expr><name>parent</name> <operator>!=</operator> <literal type="null">null</literal> <operator>&amp;&amp;</operator> <call><name><name>parent</name><operator>.</operator><name>hasNode</name></name><argument_list>(<argument><expr><name>name</name></expr></argument>)</argument_list></call></expr>)</condition> <block>{<block_content>
                 <decl_stmt><decl><type><name>NodeStateEx</name></type> <name>history</name> <init>= <expr><call><name><name>parent</name><operator>.</operator><name>getNode</name></name><argument_list>(<argument><expr><name>name</name></expr></argument>, <argument><expr><literal type="number">1</literal></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
                 <if_stmt><if>if <condition>(<expr><name>history</name> <operator>==</operator> <literal type="null">null</literal></expr>)</condition> <block>{<block_content>
                    <throw>throw <expr><operator>new</operator> <call><name>InconsistentVersioningState</name><argument_list>(<argument><expr><literal type="string">"Unexpected failure to get child node "</literal> <operator>+</operator> <name>name</name> <operator>+</operator> <literal type="string">" on parent node"</literal> <operator>+</operator> <call><name><name>parent</name><operator>.</operator><name>getNodeId</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr>;</throw>
                    <throw>throw <expr><operator>new</operator> <call><name>InconsistentVersioningState</name><argument_list>(<argument><expr><literal type="string">"Unexpected failure to get child node "</literal> <operator>+</operator> <name>name</name> <operator>+</operator> <literal type="string">" on parent node "</literal> <operator>+</operator> <call><name><name>parent</name><operator>.</operator><name>getNodeId</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr>;</throw>
                <expr_stmt/></block_content></block></if></if_stmt></block_content></block></if></if_stmt>}</block>
                <name>ChildNodeEntry</name> <name>rootv</name> <operator>=</operator> <call><name><name>history</name><operator>.</operator><name>getState</name></name><argument_list>()</argument_list></call><operator>.</operator><call><name>getChildNodeEntry</name><argument_list>(<argument><expr><name>JCR_ROOTVERSION</name></expr></argument>, <argument><expr><literal type="number">1</literal></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <if_stmt><if>if <condition>(<expr><name>rootv</name> <operator>==</operator> <literal type="null">null</literal></expr>)</condition> <block>{<block_content>
                    <throw>throw <expr><operator>new</operator> <call><name>InconsistentVersioningState</name><argument_list>(<argument><expr><literal type="string">"missing child node entry for "</literal> <operator>+</operator> <name>JCR_ROOTVERSION</name> <operator>+</operator> <literal type="string">" on version history node "</literal> <operator>+</operator> <call><name><name>history</name><operator>.</operator><name>getNodeId</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr>;</throw>
                 </block_content>}</block></if></if_stmt>
                <decl_stmt><decl><type><name>Name</name></type> <name>root</name> <init>= <expr><name><name>NameConstants</name><operator>.</operator><name>JCR_ROOTVERSION</name></name></expr></init></decl>;</decl_stmt>
                <expr_stmt><expr><name>info</name> <operator>=</operator> <operator>new</operator> <call><name>VersionHistoryInfo</name><argument_list>(
                        <argument><expr><call><name><name>history</name><operator>.</operator><name>getNodeId</name></name><argument_list>()</argument_list></call></expr></argument>,
                        <argument><expr><call><name><name>history</name><operator>.</operator><name>getState</name></name><argument_list>()</argument_list></call><operator>.</operator><call><name>getChildNodeEntry</name><argument_list>(<argument><expr><name>root</name></expr></argument>, <argument><expr><literal type="number">1</literal></expr></argument>)</argument_list></call><operator>.</operator><call><name>getId</name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
                <expr_stmt><expr><name>info</name> <operator>=</operator> <operator>new</operator> <call><name>VersionHistoryInfo</name><argument_list>(<argument><expr><call><name><name>history</name><operator>.</operator><name>getNodeId</name></name><argument_list>()</argument_list></call></expr></argument>,
                        <argument><expr><call><name><name>rootv</name><operator>.</operator><name>getId</name></name><argument_list>()</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
             }
         } <finally>finally <block>{<block_content>
             <expr_stmt><expr><call><name><name>lock</name><operator>.</operator><name>release</name></name><argument_list>()</argument_list></call></expr>;</expr_stmt>
<expr_stmt><expr><operator>-</operator> 
<literal type="number">2.19.1.windows</literal><literal type="number">.1</literal></expr></expr_stmt></block_content></block></finally>

</unit>
