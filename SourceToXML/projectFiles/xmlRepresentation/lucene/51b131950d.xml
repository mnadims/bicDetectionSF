<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<unit xmlns="http://www.srcML.org/srcML/src" revision="1.0.0" language="Java" filename="E:/01Courses@USASK/CMPT898-HumanDrivenSoftwareEngineeringForScientificResearch/ProjectProgress/data_files/final_dataset/gen_patch_codes/filtered/lucene/51b131950d.java"><expr_stmt><expr><name>From</name> <literal type="number">51b131950de0357fc64e0e951b887eb30a704cd1</literal> <name>Mon</name> <name>Sep</name> <literal type="number">17</literal> <literal type="number">00</literal><operator>:</operator><literal type="number">00</literal><operator>:</operator><literal type="number">00</literal> <literal type="number">2001</literal>
<name>From</name><operator>:</operator> <name>Shalin</name> <name>Shekhar</name> <name><name>Mangar</name> <argument_list type="generic">&lt;<argument><name>shalin</name><annotation>@<name><name>apache</name><operator>.</operator><name>org</name></name></annotation></argument>&gt;</argument_list></name>
<name>Date</name><operator>:</operator> <name>Thu</name></expr><operator>,</operator> <expr><literal type="number">5</literal> <name>May</name> <literal type="number">2016</literal> <literal type="number">21</literal><operator>:</operator><literal type="number">00</literal><operator>:</operator><literal type="number">20</literal> <operator>+</operator><literal type="number">0530</literal>
<name>Subject</name><operator>:</operator> <index>[<expr><name>PATCH</name></expr>]</index> <name>SOLR</name><operator>-</operator><literal type="number">9036</literal><operator>:</operator> <name>Solr</name> <name>slave</name> <name>is</name> <name>doing</name> <name>full</name> <call><name>replication</name> <argument_list>(<argument><expr><name>entire</name>
 <name>index</name></expr></argument>)</argument_list></call> <name>of</name> <name>index</name> <name>after</name> <name>master</name> <name>restart</name>

<operator>--</operator>
 <name>solr</name><operator>/</operator><name><name>CHANGES</name><operator>.</operator><name>txt</name></name>                              <operator>|</operator>  <literal type="number">3</literal> <operator>+</operator>
 <operator>...</operator><operator>/</operator><name>org</name><operator>/</operator><name>apache</name><operator>/</operator><name>solr</name><operator>/</operator><name>handler</name><operator>/</operator><name><name>IndexFetcher</name><operator>.</operator><name>java</name></name> <operator>|</operator>  <literal type="number">5</literal> <operator>+</operator><operator>-</operator>
 <operator>...</operator><operator>/</operator><name>solr</name><operator>/</operator><name>handler</name><operator>/</operator><name><name>TestReplicationHandler</name><operator>.</operator><name>java</name></name>  <operator>|</operator> <literal type="number">77</literal> <operator>++</operator><operator>++</operator><operator>++</operator><operator>++</operator><operator>++</operator><operator>++</operator><operator>++</operator><operator>++</operator><operator>++</operator><operator>+</operator>
 <literal type="number">3</literal> <name>files</name> <name>changed</name></expr><operator>,</operator> <expr><literal type="number">84</literal> <call><name>insertions</name><argument_list>(<argument><expr><operator>+</operator></expr></argument>)</argument_list></call></expr><operator>,</operator> <expr><literal type="number">1</literal> <call><name>deletion</name><argument_list>(<argument><expr><operator>-</operator></expr></argument>)</argument_list></call>

<name>diff</name> <operator>--</operator><name>git</name> <name>a</name><operator>/</operator><name>solr</name><operator>/</operator><name><name>CHANGES</name><operator>.</operator><name>txt</name></name> <name>b</name><operator>/</operator><name>solr</name><operator>/</operator><name><name>CHANGES</name><operator>.</operator><name>txt</name></name>
<name>index</name> <literal type="number">9c91a5ff0bf</literal><operator>..</operator><literal type="number">9dc28d91108</literal> <literal type="number">100644</literal>
<operator>--</operator> <name>a</name><operator>/</operator><name>solr</name><operator>/</operator><name><name>CHANGES</name><operator>.</operator><name>txt</name></name>
<operator>++</operator> <name>b</name><operator>/</operator><name>solr</name><operator>/</operator><name><name>CHANGES</name><operator>.</operator><name>txt</name></name>
@@ <operator>-</operator><literal type="number">184</literal></expr><operator>,</operator><expr><literal type="number">6</literal> <operator>+</operator><literal type="number">184</literal></expr><operator>,</operator><expr><literal type="number">9</literal> @@ <name>Bug</name> <name>Fixes</name>
 <operator>*</operator> <name>SOLR</name><operator>-</operator><literal type="number">9030</literal><operator>:</operator> <name>The</name> <literal type="char">'downnode'</literal> <name>overseer</name> <name>command</name> <name>can</name> <name>trip</name> <name>asserts</name> <name>in</name> <name><name>ZkStateWriter</name><operator>.</operator></name>
   (<name>Scott</name> <name>Blum</name></expr><operator>,</operator> <expr><name>Mark</name> <name>Miller</name></expr><operator>,</operator> <expr><name>shalin</name></expr></expr_stmt>)
 
<expr_stmt><expr><operator>*</operator> <name>SOLR</name><operator>-</operator><literal type="number">9036</literal><operator>:</operator> <name>Solr</name> <name>slave</name> <name>is</name> <name>doing</name> <name>full</name> <call><name>replication</name> <argument_list>(<argument><expr><name>entire</name> <name>index</name></expr></argument>)</argument_list></call> <name>of</name> <name>index</name> <name>after</name> <name>master</name> <name><name>restart</name><operator>.</operator></name>
  (<name>Lior</name> <name>Sapir</name></expr><operator>,</operator> <expr><name>Mark</name> <name>Miller</name></expr><operator>,</operator> <expr><name>shalin</name></expr></expr_stmt>)

 <expr_stmt><expr><name>Optimizations</name>
 <operator>--</operator><operator>--</operator><operator>--</operator><operator>--</operator><operator>--</operator><operator>--</operator><operator>--</operator><operator>--</operator><operator>--</operator><operator>--</operator><operator>--</operator>
 <operator>*</operator> <name>SOLR</name><operator>-</operator><literal type="number">8722</literal><operator>:</operator> <name>Don</name><literal type="char">'t force a full ZkStateReader refresh on every Overseer operation.
diff --git a/solr/core/src/java/org/apache/solr/handler/IndexFetcher.java b/solr/core/src/java/org/apache/solr/handler/IndexFetcher.java
index 224cc641382..9c1cbb60b97 100644
-- a/solr/core/src/java/org/apache/solr/handler/IndexFetcher.java
++ b/solr/core/src/java/org/apache/solr/handler/IndexFetcher.java
@@ -565,7 +565,10 @@ public class IndexFetcher {
         }
       }
 
      core.getUpdateHandler().getSolrCoreState().setLastReplicateIndexSuccess(successfulInstall);
      if (core.getCoreDescriptor().getCoreContainer().isZooKeeperAware()) {
        // we only track replication success in SolrCloud mode
        core.getUpdateHandler().getSolrCoreState().setLastReplicateIndexSuccess(successfulInstall);
      }
 
       filesToDownload = filesDownloaded = confFilesDownloaded = confFilesToDownload = tlogFilesToDownload = tlogFilesDownloaded = null;
       markReplicationStop();
diff --git a/solr/core/src/test/org/apache/solr/handler/TestReplicationHandler.java b/solr/core/src/test/org/apache/solr/handler/TestReplicationHandler.java
index cf40d4b45ad..66b2ba20d8e 100644
-- a/solr/core/src/test/org/apache/solr/handler/TestReplicationHandler.java
++ b/solr/core/src/test/org/apache/solr/handler/TestReplicationHandler.java
@@ -58,6 +58,7 @@ import org.apache.solr.common.SolrDocument;
 import org.apache.solr.common.SolrDocumentList;
 import org.apache.solr.common.SolrException;
 import org.apache.solr.common.SolrInputDocument;
import org.apache.solr.common.params.CommonParams;
 import org.apache.solr.common.params.ModifiableSolrParams;
 import org.apache.solr.common.params.SolrParams;
 import org.apache.solr.common.util.NamedList;
@@ -586,6 +587,82 @@ public class TestReplicationHandler extends SolrTestCaseJ4 {
     assertEquals(nDocs+1, numFound(rQuery(nDocs+1, "*:*", slaveClient)));
   }
 
  /**
   * We assert that if master is down for more than poll interval,
   * the slave doesn'</literal><name>t</name> <name>re</name><operator>-</operator><name>fetch</name> <name>the</name> <name>whole</name> <name>index</name> <name>from</name> <name>master</name> <name>again</name></expr></expr_stmt> <if_stmt><if>if
   * the index hasn't changed. See SOLR-9036
   */
  @Test
  public void doTestIndexFetchOnMasterRestart() throws Exception  {
    useFactory(null);
    try {
      clearIndexWithReplication();
      // change solrconfig having 'replicateAfter startup'</if></if_stmt> option on master
      master.copyConfigFile(CONF_DIR + "solrconfig-master2.xml",
          "solrconfig.xml");

      masterJetty.stop();
      masterJetty.start();

      nDocs--;
      for (int i = 0; i &lt; nDocs; i++)
        index(masterClient, "id", i, "name", "name = " + i);

      masterClient.commit();

      NamedList masterQueryRsp = rQuery(nDocs, "*:*", masterClient);
      SolrDocumentList masterQueryResult = (SolrDocumentList) masterQueryRsp.get("response");
      assertEquals(nDocs, numFound(masterQueryRsp));

      //get docs from slave and check if number is equal to master
      NamedList slaveQueryRsp = rQuery(nDocs, "*:*", slaveClient);
      SolrDocumentList slaveQueryResult = (SolrDocumentList) slaveQueryRsp.get("response");
      assertEquals(nDocs, numFound(slaveQueryRsp));

      //compare results
      String cmp = BaseDistributedSearchTestCase.compare(masterQueryResult, slaveQueryResult, 0, null);
      assertEquals(null, cmp);

      assertEquals(1, Integer.parseInt(getSlaveDetails("timesIndexReplicated")));
      String timesFailed = getSlaveDetails("timesFailed");
      assertEquals(0, Integer.parseInt(timesFailed != null ?  timesFailed : "0"));

      masterJetty.stop();

      // poll interval on slave is 1 second, so we just sleep for a few seconds
      Thread.sleep(2000);

      masterJetty.start();

      // poll interval on slave is 1 second, so we just sleep for a few seconds
      Thread.sleep(2000);

      //get docs from slave and assert that they are still the same as before
      slaveQueryRsp = rQuery(nDocs, "*:*", slaveClient);
      slaveQueryResult = (SolrDocumentList) slaveQueryRsp.get("response");
      assertEquals(nDocs, numFound(slaveQueryRsp));

      int failed = Integer.parseInt(getSlaveDetails("timesFailed"));
      assertTrue(failed &gt; 0);
      assertEquals(1, Integer.parseInt(getSlaveDetails("timesIndexReplicated")) - failed);
    } finally {
      resetFactory();
    }
  }

  private String getSlaveDetails(String keyName) throws SolrServerException, IOException {
    ModifiableSolrParams params = new ModifiableSolrParams();
    params.set(CommonParams.QT, "/replication");
    params.set("command", "details");
    QueryResponse response = slaveClient.query(params);
    System.out.println("SHALIN: " + response.getResponse());
    // details/slave/timesIndexReplicated
    NamedList&lt;Object&gt; details = (NamedList&lt;Object&gt;) response.getResponse().get("details");
    NamedList&lt;Object&gt; slave = (NamedList&lt;Object&gt;) details.get("slave");
    Object o = slave.get(keyName);
    return o != null ? o.toString() : null;
  }

   @Test
   public void doTestIndexFetchWithMasterUrl() throws Exception {
     //change solrconfig on slave
- 
2.19.1.windows.1

</unit>
